## Description: Analysis of the results of manhattan_euclides
## Author: @griverorz
## Date: 2May2012

setwd('~/Documents/wip/manhattan_euclides/')

library(reshape)
library(lattice)
library(coda)
library(boa)
library(foreign)
library(mlogit)
library(mi)
library(mitools)
library(msm)
library(rjags)
library(ggplot2)
library(R2jags)

# set theme
theme_set(theme_bw())
myblue <- rgb(100, 170, 200, max = 255)
myred <- rgb(240, 140, 100, max = 255)
mygreen <- rgb(70, 120, 35, max = 255)

## PARTY FIT
get_vote <- function(vmodel) {
    return(apply(vmodel$model$data()$voto,
                 1,
                 function (m) which(m == 1)))
  }


partyfit <- function(votes, obsvotes) {
    aa <- vector('list', nrow(votes))
    for (i in 1:nrow(votes)) {
        aa[[i]] <- diag(table(votes[i, ], obsvotes))/colSums(table(votes[i, ], obsvotes))
    }
    aa <- do.call(rbind, aa)
    out <- apply(aa, 2, function(x) quantile(x, c(.025, .5, .975)))
    return(out)
}

## OVERALL FIT
overallfit <- function(votes, obsvotes) {
    aa <- vector('numeric', nrow(votes))
    for (i in 1:nrow(vgalicia)) {
        aa[i] <- sum(diag(table(votes[i, ], obsvotes)))/ncol(votes)
    }
    return(aa)
}

## SIMULATE PROBABILITIES

## SIMULATION OF COOPTATION AREAS GIVEN LOCATION OF PARTIES

simcoefs <- function(model, prob = .5) {
    # change parameters according to the model
    betas <- model[, grepl("beta$", dimnames(model)[[2]])]
    pbeta1 <- model[, grepl("pbeta1", dimnames(model)[[2]])]
    pbeta2 <- model[, grepl("pbeta2", dimnames(model)[[2]])]
    omegas <- model[, grepl("omega", dimnames(model)[[2]])]
    rhos <- model[, grepl("rho", dimnames(model)[[2]])]

    alphas <- vector("numeric", length(pbeta1))
    ## rnorm(length, mus[1], taus[1])
    for (i in 1:length(pbeta1)) {
        alphas[i] <- rbeta(1, pbeta1[i], pbeta2[i])
    }
    coefs <- cbind(betas, alphas, rhos, omegas)
    return(coefs)
}

clog <- function(x) exp(x)/rowSums(exp(x))
colQuant <- function(x) apply(x, 2, function(d) quantile(d, c(.025, .5, .975)))

simpredprob <- function(mcmc_model, coefs) {
    nparty <- mcmc_model$model$data()$K
    N <- mcmc_model$model$data()$N
    vote <- mcmc_model$model$data()$voto
    nacl <- mcmc_model$model$data()$nacl
    ideol <- mcmc_model$model$data()$ideol

    probs <- vector("list", N)

    for (n in 1:N) {
        ## probs[, p] <- coefs[, "betas"] * (
        ##     coefs[, "alphas"] %o% distance[1] +
        ##     (1 - coefs[, "alphas"]) %o% distance[2]) +
        ##         coefs[,3:ncol(coefs)] %*% intercept
        cbind(0, coefs[, 3:ncol(coefs)])

        probs[[n]] <- coefs[, 1] %o% ideol[n, ] +
                      coefs[, 2] %o% nacl[n, ] +
                      cbind(0, coefs[, 3:ncol(coefs)])
    }

    probs <- lapply(probs, clog)
    probs <- lapply(probs, colQuant)
    ## probs <- do.call("rbind", probs)
    return(probs)
}


## COMPARE DIC
diffdic <- function(dic1, dic2) {
    delta <- sapply(dic1$BUGSoutput$sims.list$deviance, mean) +
             sapply(dic1$BUGSoutput$pD, mean) -
             sapply(dic2$BUGSoutput$sims.list$deviance, mean) -
             sapply(dic2$BUGSoutput$pD, mean)
    return(delta)
}


## Load models and compare fit
load("dta/mcmc_data/gal_fullnopenalized.RData")
load("dta/mcmc_data/eus_re_full.RData")

gfull_mcmc <- fit[[1]]
gfull <- as.mcmc(gfull_mcmc)
galicia_voto <- get_vote(gfull_mcmc)

gcoefs <- simcoefs(gfull)

load("dta/mcmc_data/gal_re_full.RData")
efull_mcmc <- fit[[1]]
efull <- as.mcmc(efull_mcmc)
euskadi_voto <- get_vote(efull_mcmc)

load("dta/mcmc_data/cat_re_full.RData")
cfull_mcmc <- fit[[1]]
cfull <- as.mcmc(cfull_mcmc)
euskadi_voto <- get_vote(cfull_mcmc)

vgalicia <- extract_vote(gfull, categories = 3)
vgalicia <- simvote(vgalicia, 1, 3)
vgalicia <- do.call(cbind, vgalicia)

partyfit(vgalicia, galicia_voto)
quantile(overallfit(vgalicia, galicia_voto), c(.025, .5, .975))

## SIMULATION OF COEFFICIENTS
load("dta/mcmc_data/gal_re_full.RData")
g_full <- as.mcmc(fitmodel)
simgal <- simcoefs(g_full)

load("dta/mcmc_data/eus_re_full_rho_nogamma.RData")
e_full <- as.mcmc(fitmodel)
simeus <- simcoefs(e_full)

load("dta/mcmc_data/cat_re_full_rho_nogamma.RData")
c_full <- as.mcmc(fitmodel)
simcat <- simcoefs(c_full)

sims <- as.data.frame(c(simgal[,2], simeus[,2], simcat[,2]))
sims$region <- as.vector(mapply(rep,
                                c("Galicia", "Basque Country", "Catalonia"),
                                c(nrow(simgal),
                                  nrow(simeus),
                                  nrow(simcat))))

names(sims) <- c("weight", "region")
sims <- melt(sims)

## Figure
p <- ggplot(sims, aes(x = value, colour = region, group = variable))
pq <- p + geom_density(aes(group = region, linetype = region), size = 1) +
    ## facet_grid(. ~ variable, as.table = TRUE) +
    geom_vline(xintercept = 0.5, linetype = 2) +
    scale_colour_manual(name = "Region",
                        breaks = c("Galicia", "Basque Country", "Catalonia"),
                        labels = c("Galicia", "Basque Country", "Catalonia"),
                        values = c("Galicia" = myblue,
                                   "Basque Country" = mygreen,
                                   "Catalonia" = myred)) +
    scale_y_continuous("Density") +
    scale_linetype_manual(name = "Region",
                          breaks = c("Galicia", "Basque Country", "Catalonia"),
                          labels = c("Galicia", "Basque Country", "Catalonia"),
                          values = c("Galicia" = 4,
                          "Basque Country" = 5,
                          "Catalonia" = 3)) +
    scale_x_continuous("Dimensional weight", limits = c(0,1))
ggsave("img/distribution_full.pdf", pq)

